# source("https://bioconductor.org/biocLite.R")
# biocLite("EBImage")

suppressPackageStartupMessages({
  require(parallel)
  require(magrittr)
  require(magick)
  require(tesseract)
  require(EBImage)
  require(keras)
})

dir.create("img27")

for (i in 1:length(dat$url)) {
  system(paste0("ffmpeg -i ", dat$url[i], " -vf 'select=eq(n\\,0)' -q:v 3 ~/CMWT/img27/oi", i, ".png"))
}

numbers <- tesseract(options = list(tessedit_char_whitelist = "-:0123456789"))

hg <- 4:25

vec <- list(4:15, 16:30, 31:45, 47:63, 79:95, 96:110, 127:143, 144:160, 178:192, 192:207, 221:239, 240:255, 272:287, 288:303)
vec2 <- list(4:15, 16:30, 31:45, 47:63, 79:95, 96:110, 127:143, 144:160, 240:255, 256:271, 288:303, 304:319, 334:349, 351:366)
vec3 <- list(15:24, 24:33, 36:44, 45:51, 58:65, 66:73, 74:80, 82:88, 95:101, 103:109, 115:122, 123:130, 135:143, 144:151)
vec4 <- list(5:15, 16:27, 28:38, 39:48, 58:67, 68:77, 86:95, 96:105, 120:129, 130:139, 148:157, 159:168, 176:185, 187:196)

fl <- list.files("~/CMWT/img27/", full.names = T)
idx <- readr::parse_number(substr(fl, 38, 50))

train_photo <- data_frame(
  photo = fl,
  channel = dat$news_source[idx]
)

ip_keras <- function(img, nam) {
  lena5 <- readImage(img)
  if (nam == "ТК Київ") {
    vec <- vec3
    hg <- 4:15
  } else if (nam == "СТБ") {
    vec <- vec4
    hg <- 5:19
  } else if (nam %in% c("ТК Перший діловий", "ТК Интер", "ТК 24")) {
    vec <- vec2
  }
  mclapply(vec, function(x) {
    ln <- ln[x, hg, 1:3] %>% resize(w = 256, h = 256) %>% channel("gray")
    ln <- lena5 > mean(ln@.Data)
    ln %>% EBImage::imageData()
  }, mc.cores = 8)
}

ip_keras <- compiler::cmpfun(ip_keras)

keras_mas <- map2(train_photo %>% pull(photo), train_photo %>% pull(channel), ip_keras)

keras_mas2 <- unlist(keras_mas, recursive = FALSE)

keras_mas2 <- lapply(keras_mas2, function(x) array(x, dim = c(1, 256, 256)))

keras_mas2 <- abind(keras_mas2, along = 1)

num <- c(
  c(2, 0, 1, 8, 0, 4, 2, 7, 0, 7, 3, 4, 1, 9), # 1
  c(2, 0, 1, 8, 0, 4, 2, 7, 0, 7, 4, 1, 1, 2), # 2
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 5, 0, 6, 4, 5), # 3
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 6, 4, 1, 1, 4), # 4
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 6, 4, 4, 3, 9), # 5
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 6, 3, 3, 5, 1), # 6
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 6, 3, 8, 2, 6), # 7
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 6, 5, 3, 0, 8), # 8
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 6, 4, 5, 1, 1), # 9
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 6, 4, 9, 1, 6), # 10
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 6, 3, 1, 1, 2), # 11
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 6, 3, 3, 2, 3), # 12
  c(2, 0, 1, 8, 0, 4, 2, 7, 0, 7, 3, 9, 4, 4), # 13
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 6, 3, 9, 1, 2), # 14
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 6, 4, 8, 1, 4), # 15
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 6, 3, 5, 2, 0), # 16
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 7, 0, 6, 2, 5), # 17
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 7, 0, 2, 4, 6), # 18
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 7, 0, 0, 3, 6), # 19
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 7, 0, 6, 2, 0), # 20
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 7, 0, 2, 0, 4), # 21
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 7, 0, 2, 2, 4), # 22
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 7, 1, 1, 2, 3), # 23
  c(2, 0, 1, 8, 0, 4, 2, 7, 0, 7, 2, 0, 2, 8), # 24
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 7, 0, 1, 2, 0), # 25
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 7, 0, 8, 5, 6), # 26
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 7, 0, 0, 4, 8), # 27
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 7, 1, 3, 5, 8), # 28
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 7, 0, 5, 5, 3), # 29
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 7, 0, 4, 2, 8), # 30
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 7, 0, 7, 3, 0), # 31
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 7, 0, 1, 4, 9), # 32
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 7, 0, 5, 1, 8), # 33
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 7, 1, 0, 4, 5), # 34
  c(2, 0, 1, 8, 0, 4, 2, 7, 0, 7, 3, 6, 2, 2), # 35
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 7, 0, 2, 3, 8), # 36
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 7, 1, 1, 5, 6), # 37
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 7, 0, 9, 4, 5), # 38
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 7, 0, 6, 5, 0), # 39
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 7, 5, 5, 2, 4), # 40 STB!!!
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 7, 3, 0, 2, 5), # 41 STB!!!
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 7, 3, 3, 1, 7), # 42 STB!!!
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 7, 3, 1, 2, 4), # 43 STB!!!
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 7, 3, 6, 5, 6), # 44 STB!!!
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 7, 4, 7, 5, 9), # 45 STB!!!
  c(2, 0, 1, 8, 0, 4, 2, 7, 0, 8, 2, 2, 4, 6), # 46 INTER
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 7, 3, 4, 3, 7), # 47 STB!!!
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 7, 4, 8, 5, 8), # 48 STB!!!
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 7, 4, 3, 3, 9), # 49 STB!!!
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 7, 5, 7, 2, 2), # 50 STB!!!
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 8, 0, 2, 5, 9), # 51 INTER
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 8, 0, 1, 3, 3), # 52 INTER
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 7, 4, 0, 2, 6), # 53 INTER
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 7, 5, 9, 3, 4), # 54 INTER
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 7, 5, 5, 1, 6), # 55 INTER
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 7, 5, 2, 2, 4), # 56 INTER
  c(2, 0, 1, 8, 0, 4, 2, 7, 0, 8, 2, 7, 2, 8), # 57 INTER
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 7, 4, 3, 2, 5), # 58 INTER
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 7, 5, 7, 3, 2), # 59 INTER
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 7, 4, 1, 5, 4), # 60 INTER
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 7, 4, 1, 2, 1), # 61 INTER
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 7, 4, 5, 3, 5), # 62 INTER
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 7, 4, 8, 5, 0), # 63 INTER
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 7, 4, 2, 5, 7), # 64 INTER
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 7, 4, 9, 5, 7), # 65 INTER
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 7, 4, 6, 0, 4), # 66 INTER
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 8, 0, 8, 2, 5), # 67
  c(2, 0, 1, 8, 0, 4, 2, 7, 0, 8, 1, 5, 4, 2), # 68 INTER
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 8, 0, 1, 5, 1), # 69
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 8, 0, 7, 5, 5), # 70
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 8, 0, 8, 3, 9), # 71
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 8, 1, 3, 1, 6), # 72
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 8, 1, 4, 4, 9), # 73
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 8, 0, 2, 2, 6), # 74
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 8, 0, 5, 0, 6), # 75
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 7, 5, 8, 5, 3), # 76 STB!!!
  c(2, 0, 1, 8, 0, 4, 2, 7, 0, 6, 1, 5, 4, 6), # 77 24
  c(2, 0, 1, 8, 0, 4, 2, 7, 0, 6, 0, 1, 5, 8), # 78 24
  c(2, 0, 1, 8, 0, 4, 2, 7, 0, 8, 2, 5, 2, 2), # 79 INTER
  c(2, 0, 1, 8, 0, 4, 2, 7, 0, 6, 0, 0, 2, 8), # 80 24
  c(2, 0, 1, 8, 0, 4, 2, 7, 0, 6, 1, 1, 0, 4), # 81 24
  c(2, 0, 1, 8, 0, 4, 2, 7, 0, 6, 0, 4, 2, 4), # 82 24
  c(2, 0, 1, 8, 0, 4, 2, 7, 0, 6, 0, 6, 4, 0), # 83 24
  c(2, 0, 1, 8, 0, 4, 2, 7, 0, 6, 2, 6, 4, 9), # 84 24
  c(2, 0, 1, 8, 0, 4, 2, 7, 0, 6, 2, 9, 4, 1), # 85 24
  c(2, 0, 1, 8, 0, 4, 2, 7, 0, 6, 2, 0, 4, 2), # 86 24
  c(2, 0, 1, 8, 0, 4, 2, 7, 0, 6, 1, 2, 0, 5), # 87 24
  c(2, 0, 1, 8, 0, 4, 2, 7, 0, 6, 2, 4, 1, 4), # 88 24
  c(2, 0, 1, 8, 0, 4, 2, 7, 0, 6, 1, 8, 4, 1), # 89 24
  c(2, 0, 1, 8, 0, 4, 2, 7, 0, 8, 3, 3, 4, 4), # 90 INTER
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 8, 1, 0, 1, 9), # 91
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 8, 1, 0, 3, 1), # 92
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 8, 2, 6, 1, 0), # 93
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 8, 1, 6, 0, 3), # 94
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 8, 1, 8, 2, 4), # 95
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 8, 0, 8, 1, 0), # 96
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 8, 2, 2, 1, 9), # 97
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 8, 1, 1, 5, 3), # 98
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 8, 0, 0, 5, 5), # 99
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 8, 0, 6, 1, 2), # 100
  c(2, 0, 1, 8, 0, 4, 2, 7, 0, 8, 1, 3, 0, 7), # 101 INTER
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 8, 2, 0, 4, 0), # 102
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 8, 0, 4, 0, 9), # 103
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 8, 0, 5, 0, 4), # 104
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 8, 1, 2, 2, 7), # 105
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 8, 0, 5, 3, 9), # 106
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 8, 0, 1, 5, 9), # 107
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 8, 1, 0, 1, 8), # 108
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 8, 0, 2, 3, 3), # 109
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 8, 0, 8, 4, 3), # 110
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 8, 0, 9, 1, 3), # 111
  c(2, 0, 1, 8, 0, 4, 2, 7, 0, 7, 2, 3, 0, 2), # 112 INTER
  c(2, 0, 1, 8, 0, 4, 2, 7, 0, 8, 3, 8, 5, 3), # 113 INTER
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 8, 0, 3, 1, 9), # 114
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 8, 0, 6, 5, 2), # 115
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 8, 1, 1, 2, 6), # 116
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 8, 0, 7, 2, 0), # 117
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 8, 0, 1, 2, 7), # 118
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 8, 0, 8, 1, 4), # 119
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 8, 1, 3, 2, 6), # 120
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 8, 0, 4, 4, 3), # 121
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 8, 0, 3, 0, 3), # 122
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 8, 0, 5, 3, 2), # 123
  c(2, 0, 1, 8, 0, 4, 2, 7, 0, 8, 3, 5, 5, 5), # 124 INTER
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 8, 0, 6, 4, 6), # 125
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 8, 0, 8, 1, 5), # 126
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 8, 0, 8, 5, 8), # 127
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 8, 0, 7, 2, 9), # 128
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 8, 0, 9, 5, 8), # 129
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 8, 0, 1, 5, 5), # 130
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 8, 0, 1, 0, 0), # 131
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 8, 2, 2, 3, 1), # 132
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 8, 0, 9, 4, 4), # 133
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 8, 0, 7, 3, 5), # 134
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 0, 0, 7, 1, 5), # 135 INTER
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 8, 2, 3, 0, 5), # 136
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 8, 1, 8, 4, 4), # 137
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 8, 2, 1, 1, 5), # 138
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 8, 0, 2, 4, 1), # 139
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 8, 0, 4, 3, 6), # 140
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 8, 0, 5, 3, 7), # 141
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 8, 0, 7, 0, 8), # 142
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 8, 1, 1, 1, 9), # 143
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 8, 1, 6, 1, 2), # 144
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 8, 1, 5, 4, 7), # 145
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 2, 1, 8, 2, 1), # 146
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 8, 1, 2, 4, 3), # 147
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 8, 3, 1, 2, 8), # 148
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 8, 1, 6, 3, 3), # 149
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 8, 3, 5, 2, 2), # 150
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 8, 3, 4, 3, 0), # 151
  c(2, 0, 1, 8, 0, 4, 2, 7, 1, 8, 2, 0, 3, 1) # 152
)

x_train <- keras_mas2[c(1:1500), , ] / 255
x_test <- keras_mas2[c(1501:2128), , ] / 255
y_train <- array(num[c(1:1500)]) %>% to_categorical(10)
y_test <- array(num[c(1501:2128)]) %>% to_categorical(10)

model <- keras_model_sequential()

model %>%
  layer_conv_1d(filter = 256, kernel_size = c(3), padding = "same", input_shape = c(256, 256)) %>%
  layer_activation("relu") %>%
  layer_conv_1d(filter = 256, kernel_size = c(3)) %>%
  layer_activation("relu") %>%
  layer_max_pooling_1d(pool_size = c(2)) %>%
  layer_dropout(0.25) %>%
  layer_conv_1d(filter = 256, kernel_size = c(3), padding = "same") %>%
  layer_activation("relu") %>%
  layer_conv_1d(filter = 256, kernel_size = c(3)) %>%
  layer_activation("relu") %>%
  layer_max_pooling_1d(pool_size = c(2)) %>%
  layer_dropout(0.25) %>%
  layer_flatten() %>%
  layer_dense(512) %>%
  layer_activation("relu") %>%
  layer_dropout(0.5) %>%
  layer_dense(10) %>%
  layer_activation("softmax")

opt <- optimizer_rmsprop(lr = 0.0001, decay = 1e-6)

model %>% compile(
  loss = "categorical_crossentropy",
  optimizer = opt,
  metrics = "accuracy"
)

model %>% keras::fit(
  x_train, y_train,
  batch_size = 100,
  epochs = 75,
  validation_data = list(x_test, y_test),
  shuffle = TRUE
)

preds <- model %>% predict_classes(x_test)

table(preds, num[701:1400])

keras::save_model_hdf5(model, "model.hdf5")

model <- load_model_hdf5("model.hdf5")

vec_img <- train_photo %>% pull(photo)

names(vec_img) <- train_photo %>% pull(channel)

keras_mas3 <- map2(vec_img, names(vec_img), ip_keras) %>% unlist(recursive = FALSE) %>% lapply(function(x) array(x, dim = c(1, 256, 256))) %>% abind(along = 1)

preds_new <- model %>% predict_classes(keras_mas2 / 255)

chunk2 <- function(x, n) split(x, cut(seq_along(x), n, labels = FALSE))

preds_new <- preds_new %>%
  chunk2(length(preds_new) / 14) %>%
  map_chr(function(x) paste(x, collapse = "")) %>%
  lubridate::ymd_hms(tz = "Europe/Kiev") # %>%

ad <- preds_new[preds_new > Sys.time() - 3600 * 24 * 10 & preds_new < Sys.time() & is.finite(preds_new)]